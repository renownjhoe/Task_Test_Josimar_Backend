name: Deploy to AWS EC2

on:
  push:
    branches:
      - main  # Change this to your deployment branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_KEY_PAIR_PEM }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_PUBLIC_IP }} >> ~/.ssh/known_hosts

      - name: Copy project to EC2
        run: |
          scp -r . ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_PUBLIC_IP }}:/home/ubuntu/app

      - name: SSH to EC2 and deploy
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          # Update and install necessary packages
          sudo apt update && sudo apt install -y docker.io nginx

          # Enable and start Docker & Nginx
          sudo systemctl enable docker nginx
          sudo systemctl start docker nginx

          # Configure Nginx
          sudo tee /etc/nginx/sites-available/default > /dev/null <<'EOT'
            server {
              listen 80;
              server_name ${{ secrets.EC2_PUBLIC_IP_OR_DOMAIN }};

              location / {
                proxy_pass http://localhost:3000;
                proxy_set_header Host \$host;
                proxy_set_header X-Real-IP \$remote_addr;
                proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
              }
            }
          EOT

          # Link the site and restart Nginx
          sudo ln -sf /etc/nginx/sites-available/default /etc/nginx/sites-enabled/
          sudo systemctl restart nginx

          # Deploy Docker container
          # mkdir -p /home/ubuntu/app
          cd /home/ubuntu/app
          # git clone --depth 1 <your-repo-clone-url> . # Replace with your repo URL
          docker build -t brume .
          docker stop brume-container || true
          docker rm brume-container || true
          docker run -d --name brume-container -p 3000:3000 brume
        EOF
